name: Deploy UPM Package

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Auto-detect package.json and deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Find package.json and extract version
        id: extract_version
        run: |
          MATCH_FILE=$(find . -type f -name package.json -exec grep -l '"name": "com.undercats.boyou"' {} \;)
          
          if [ -z "$MATCH_FILE" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y package.json ph√π h·ª£p!"
            exit 1
          fi

          VERSION=$(jq -r .version "$MATCH_FILE")
          echo "MATCH_FILE=$MATCH_FILE" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          echo "‚úÖ Found package.json at $MATCH_FILE"
          echo "üî¢ Version: $VERSION"

      - name: Deploy UPM package
        run: |
          set -ex

          SEMVER="$VERSION"
          if [ -z "$SEMVER" ]; then
            echo "You must provide the --semver option."
            exit 1
          fi

          # Lo·∫°i b·ªè ./ ·ªü ƒë·∫ßu n·∫øu c√≥
          PREFIX=$(dirname "$MATCH_FILE" | sed 's|^\./||')
          BRANCH="upm"

          # T√°ch subtree v√† g·∫Øn tag
          git subtree split --prefix="$PREFIX" --branch $BRANCH
          git tag "$SEMVER" $BRANCH

          # Ch·ªâ ƒë·∫©y tag (kh√¥ng ƒë·∫©y nh√°nh)
          git push origin --tags

          # D·ªçn d·∫πp nh√°nh local t·∫°m
          git branch -D $BRANCH
